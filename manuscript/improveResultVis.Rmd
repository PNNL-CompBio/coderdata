---
title: "IMPROVE benchmark results"
author: "Sara gosline"
date: "2025-03-27"
output: html_document
---

This document describes basic analysis to carry out from the cross-study analysis work that the IMPROVE team has produced. The results are currently stored in Synapse and we illustrate how to visualize them. Currently we focus on two primary analyses: performance of cross-model prediction between cell line and ex vivo datasets, and performance of proteomics predictions. 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo  =  TRUE)
library(tidyverse)
library(synapser)

synapser::synLogin()

source('resultPlottingFunctions.R')

```

## Collect cross-model performance data and try out plotting
Currently the cross-model data results have been uploaded to synapse. Please request access on the [synapse team site](https://www.synapse.org/Team:3545388). 

```{r data, message=FALSE, echo=FALSE, warning=FALSE} 
  cdres <- getModelPerformanceData()
  metrics <- c('pcc','scc')
  res <- lapply(metrics,function(x) {
    res <- doFullPlot(x)
    cowplot::plot_grid(res$src,res$trg)
    ggsave(paste0(prefix,'_',metric,'_ridglines.pdf'),height = ifelse(prefix == 'all',12,8),width = 10)
    return(res$src)
})

print(res)

```

## Figure 3: performance on cell lines

First result: evaluation on cell lines.

```{r model performance, message = FALSE, warning = FALSE}
#current list of ex vivo datasets. include liverpdo when complete
exvivo = c('mpnst','beataml','sarcpdo','pancpdo','bladderpdo')

doModelPlot <- function(metric, dataset=cdres){
  
    sr <- dataset |>
      subset(met == metric)
    ##re-rank src samples by mean metric
    mvals <- sr |> 
      group_by(trg) |>
      summarize(mvals = mean(value)) |>
      arrange(mvals)
    
    if(metric == 'r2') {
      sr$value <- sapply(sr$value,function (x) ifelse(x<(-1),-1,x))
    }
    
    sr$trg = factor(sr$trg,levels = mvals$trg)
    
    sr|>subset(trg%in%exvivo)|>
      ggplot(aes(x = value,alpha = 0.8))+
      geom_histogram()+facet_grid(model~trg)+
      ggtitle(paste0(metric,' evaluated on ex vivo data'))
    
  
  ggsave(paste0(metric,'exVivoPerformance.png'))
  
      
    sr |> subset(!trg %in% exvivo) |>
      ggplot(aes(x = value,alpha = 0.8)) +
      geom_histogram() + facet_grid(model~trg) +
      ggtitle(paste0(metric,' evaluated on cell line data'))
    
  
  ggsave(paste0(metric,'CellLinePerformance.png'))

}

ecdres <- subset(cdres,trg %in% exvivo)
ccdres <- subset(cdres,!trg %in% exvivo)
eres = lapply(metrics,function(x) doFullPlot(x, ecdres,'exvivo'))
print(eres)
ccres = lapply(metrics,function(x) doFullPlot(x, ccdres,'cellline'))
print(ccres)

```

## Figure 4 - performance on ex vivo

## Compare dataset size to performance

We wonder if the dataset size affects the predictive power.

```{r dataset size}

#number of combos
combos = list(beataml = 3033,ccle = 10911,ctrpv2 = 303520,fimm = 2457 ,gcsi = 12320,
             gdscv1 = 105808,gdscv2 = 45323,mpnst = 250, nci60 = 2317205,prism = 633169)
#todo: we can also evaluate number of samples or drugs

#e can get performance summaries
gres <- ccdres  |>
  subset(model!='uno')|>
  subset(met=='scc') |>
  group_by(met,src,trg,model) |>
  summarize(meanVal=mean(value)) |>
  left_join(data.frame(src = names(combos),sampleNum = unlist(combos))) |>
  arrange(meanVal)

mom <- gres|>group_by(src,sampleNum)|>summarize(mv=mean(meanVal))|>arrange(mv)

#gres <- subset(gres,met=='scc')
gres$src = factor(gres$src,levels=unique(mom$src))
gres |> 
  ggplot(aes(x=src,y=meanVal,fill=model))+geom_boxplot()#+geom_jitter()


```

## Compare proteomics vs. transcriptomics

What does this figure look like



