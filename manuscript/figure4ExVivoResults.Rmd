---
title: "Figure 4 ex vivo results"
author: "Sara Gosline"
date: "2025-06-02"
output: html_document
---

This figure focuses on the ex vivo results

## Data and packages

First we get the packages loaded and logged into synapse.
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo  =  TRUE)
library(tidyverse)
library(ggplot2)
library(arrow)
library(dplyr)

source('coderdataResultsFunctions.R')
```


The data has been uploaded by natasha and can be downloaded as follows.

```{r download data, eval}

  cdres <- getModelPerformanceData()

  ecdres <- subset(cdres,trg %in% exvivo)


```

## Figure 4A


```{r, eval=FALSE}
metrics <- c('scc','pcc')
exres = lapply(metrics,function(x) {
  res<-ridgelineMetricPlots(x, ecdres,'cellline')
  cowplot::plot_grid(res$src,res$trg)
  ggsave(paste0('exvivo',x,'_ridglines.pdf'),height = 8,width = 10)
  return(res$src)
  })

print(exres)
```

Now we can confirm that the datasets follow the same pattern. 

```{r dataset samples, eval=FALSE}


plot<-calcSourceStatistics('scc',ecdres)


ggsave('exVivoSamplePerformanceCorrelation.pdf',plot, height=12,width=5)
print(plot)

```

## Create funtion to dive in


Full model predictions are stored on synapse as parquet files. Individual
datasets can be downloaded via `getModelPredictionData` in
`coderdataResultsFunctions.R` (sources during the setup process).
```{r lgbm data import}

lgbm_all_preds <- getModelPredictionData(dset = "lgbm")

```

```{r subsetting data}
query <- lgbm_all_preds |>
  dplyr::filter(target == 'mpnst')

mpnst_response_data <- query |> collect()
```

```{r}
options(repr.plot.width = 5, repr.plot.height = 15)
plot <- ggplot(mpnst_response_data, aes(x=auc_true, y=auc_pred)) + geom_point() + geom_smooth(method=lm) + facet_grid(source ~ .)
ggsave('mpnst_auc_plot.pdf', plot, dpi=300, width=5, height=20)
```

